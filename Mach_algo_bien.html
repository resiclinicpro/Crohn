<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curso Interactivo sobre Enfermedad de Crohn</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
    </style>
</head>
<body class="bg-slate-50">

    <div id="app-container" class="relative min-h-screen lg:flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 bg-slate-900 text-slate-300 w-80 p-6 flex flex-col transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out z-30 shadow-2xl">
            <div class="flex-1 overflow-y-auto min-h-0 pr-2">
                <h2 class="text-2xl font-bold text-center text-sky-400 border-b border-slate-700 pb-4 mb-6">Módulos Crohn</h2>
                <ul id="module-list" class="space-y-2"></ul>
            </div>
            <button id="reset-button" class="w-full bg-red-600/90 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-all hover:bg-red-600 active:scale-95 mt-4 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7V9a1 1 0 01-2 0V3a1 1 0 011-1zm12 1a1 1 0 011 1v3.099A5.002 5.002 0 008.113 14.666 1 1 0 016.228 14A7.002 7.002 0 0115.898 7.534V5a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                Reiniciar Progreso
            </button>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 lg:ml-80 p-4 sm:p-6 lg:p-8 transition-all duration-300">
            <!-- Hamburger button for mobile -->
            <button id="menu-toggle" class="lg:hidden fixed top-4 right-4 bg-white p-2 rounded-full shadow-lg z-40 text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
            </button>

            <div id="progress-container" class="w-full bg-slate-200 rounded-full mb-8 shadow-inner">
                <div id="progress-bar" class="bg-sky-500 text-xs font-medium text-white text-center p-1.5 leading-none rounded-full transition-all duration-500" style="width: 0%">0%</div>
            </div>
            <div id="module-display" class="transition-opacity duration-300">
                <!-- El contenido del módulo se insertará aquí -->
            </div>
        </main>
        
        <div id="sidebar-overlay" class="hidden lg:hidden fixed inset-0 bg-black bg-opacity-60 z-20"></div>

    </div>
    
    <!-- Reset Modal -->
    <div id="reset-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full text-center transform scale-95 transition-transform duration-300">
            <h3 class="text-xl font-bold text-slate-800">Confirmar Acción</h3>
            <p class="text-slate-600 my-4">¿Estás seguro de que quieres borrar todo tu progreso? Esta acción no se puede deshacer.</p>
            <div class="flex justify-center gap-4 mt-6">
                <button id="cancel-reset" class="py-2 px-6 bg-slate-200 text-slate-800 font-semibold rounded-lg hover:bg-slate-300 transition-colors">Cancelar</button>
                <button id="confirm-reset" class="py-2 px-6 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- Gemini Explanation Modal -->
    <div id="gemini-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full text-left transform scale-95 transition-transform duration-300 relative">
            <button id="close-gemini-modal" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-sky-500 to-emerald-500">✨</span>
                Explicación Sencilla
            </h3>
            <div id="gemini-content" class="text-slate-600 my-4 space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <!-- Loading Spinner -->
                <div id="gemini-loader" class="flex justify-center items-center py-8">
                    <svg class="animate-spin h-8 w-8 text-sky-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <!-- Gemini Response will be injected here -->
                <p id="gemini-response" class="hidden"></p>
            </div>
        </div>
    </div>

    <script>
        const courseModules = [
            {
                id: 1,
                title: "Módulo 1: ¿Qué es la Enfermedad de Crohn? Fundamentos Esenciales",
                summary: `Este módulo sienta las bases para comprender la Enfermedad de Crohn. Se explora su epidemiología global, demostrando por qué ya no es solo una "enfermedad occidental". Analizaremos la compleja interacción de factores de riesgo, incluyendo la predisposición genética (ej. mutaciones en NOD2), los factores ambientales como el tabaquismo y la dieta, y su impacto en la enfermedad. Finalmente, se desglosa la fisiopatología clave: la disfunción de la barrera intestinal y la desregulación de la respuesta inmune (Th1/Th17), que resulta en una inflamación crónica y transmural característica.`,
                clinicalCase: `Un estudiante universitario de 22 años, fumador activo (10 cigarrillos/día), acude a consulta refiriendo un historial de 6 meses de fatiga progresiva, dolor abdominal tipo cólico difuso, principalmente postprandial, y una pérdida de peso no intencionada de 5 kg. No presenta diarrea sanguinolenta, pero sí ha notado 3-4 deposiciones diarias más blandas de lo habitual. Su padre fue diagnosticado con Enfermedad de Crohn a los 30 años. El paciente está particularmente ansioso, no solo por sus síntomas, sino por el impacto que un diagnóstico similar podría tener en su futuro académico y personal.<br><br><strong>Pregunta clave:</strong> Ante este cuadro insidioso en un paciente joven con factores de riesgo genéticos y ambientales claros, ¿cuál es el mecanismo fisiopatológico subyacente más distintivo que se sospecharía en la Enfermedad de Crohn en comparación con otras colitis?`,
                quiz: [
                    {
                        question: `En el contexto fisiopatológico de la Enfermedad de Crohn, ¿cuál de las siguientes opciones describe con mayor precisión la naturaleza de la respuesta inflamatoria que la distingue de la colitis ulcerosa?`,
                        options: [
                            "Una respuesta inflamatoria superficial limitada a la mucosa, mediada principalmente por células Th2, que provoca una producción excesiva de moco.",
                            "Una respuesta inmune desregulada, predominantemente Th1 y Th17, que conduce a una inflamación transmural (que afecta a todo el espesor de la pared intestinal) y la posible formación de granulomas no caseificantes.",
                            "Una infiltración neutrofílica aguda y difusa que causa abscesos crípticos extensos, pero que rara vez se extiende más allá de la submucosa.",
                            "Una reacción de hipersensibilidad tipo IV mediada por eosinófilos en respuesta a alérgenos alimentarios, causando edema y engrosamiento de la pared intestinal."
                        ],
                        answer: 1,
                        justification: `La característica distintiva de la Enfermedad de Crohn es la inflamación transmural, impulsada por las vías Th1/Th17. Esto contrasta con la colitis ulcerosa, que es una inflamación predominantemente mucosa mediada por Th2. Los granulomas, aunque no siempre presentes, son patognomónicos de Crohn. Las otras opciones describen patrones más típicos de colitis ulcerosa, colitis infecciosa o enteritis eosinofílica.`,
                        source: `(Enfermedad de Crohn - The lancet 2024.pdf)`
                    },
                    {
                        question: `El paciente tiene un familiar de primer grado con Enfermedad de Crohn. ¿Cómo debe interpretarse el rol de la mutación del gen NOD2 en este contexto?`,
                        options: [
                            "La presencia de una mutación en NOD2 confirmaría el diagnóstico de Enfermedad de Crohn y lo descartaría para Colitis Ulcerosa.",
                            "La mutación en NOD2 es el principal factor de riesgo, superando al tabaquismo, y se asocia con una disfunción de las células de Paneth y una respuesta alterada a los componentes bacterianos.",
                            "Aunque es el factor de riesgo genético más potente, no es diagnóstico por sí mismo y su presencia solo aumenta la susceptibilidad a la enfermedad, sin ser una causa directa.",
                            "La mutación NOD2 se relaciona principalmente con la colitis en la Enfermedad de Crohn; la enfermedad ileal está más asociada a otros loci genéticos."
                        ],
                        answer: 2,
                        justification: `NOD2 es un gen de susceptibilidad, no un gen diagnóstico. Su mutación aumenta significativamente el riesgo pero no garantiza el desarrollo de la enfermedad. Su función está ligada al reconocimiento de componentes bacterianos y la función de las células de Paneth. El tabaquismo sigue siendo un factor de riesgo ambiental extremadamente potente. Su asociación más fuerte es con la enfermedad ileal, no colónica.`,
                        source: `(Enfermedad de Crohn - The lancet 2024.pdf)`
                    },
                    {
                        question: `Considerando la epidemiología global de la Enfermedad de Crohn, ¿cuál de las siguientes afirmaciones refleja con mayor precisión las tendencias actuales?`,
                        options: [
                            "La incidencia y prevalencia están disminuyendo en todo el mundo debido a las mejoras en la higiene y el tratamiento precoz.",
                            "Las tasas más altas de incidencia se mantienen exclusivamente en Europa y Norteamérica, sin cambios significativos en otras regiones.",
                            "La incidencia se está estabilizando o disminuyendo en los países occidentales, pero está aumentando rápidamente en países recién industrializados de Asia y América del Sur.",
                            "La prevalencia global está disminuyendo, aunque la incidencia en niños está aumentando, lo que sugiere un cambio en los factores de riesgo ambientales."
                        ],
                        answer: 2,
                        justification: `La Enfermedad de Crohn se ha convertido en una enfermedad global. Mientras que las regiones tradicionalmente de alta incidencia (Europa, Norteamérica) ven una estabilización, las regiones emergentes están experimentando un rápido aumento, probablemente debido a la "occidentalización" del estilo de vida y la dieta. La prevalencia global está aumentando debido a la cronicidad de la enfermedad y la baja mortalidad, no disminuyendo.`,
                        source: `(Enfermedad de Crohn - The lancet 2024.pdf)`
                    },
                    {
                        question: `El paciente es un fumador activo. Desde una perspectiva fisiopatológica, ¿cuál es el impacto más significativo y multifacético del tabaquismo en la Enfermedad de Crohn?`,
                        options: [
                            "Aumenta directamente la permeabilidad intestinal al dañar las uniones estrechas, pero no afecta la respuesta inmune sistémica.",
                            "Actúa principalmente como un vasoconstrictor, reduciendo el flujo sanguíneo mesentérico y promoviendo la isquemia crónica en el íleon terminal.",
                            "Modula negativamente la respuesta inmune, altera la composición del microbioma, aumenta el riesgo de recurrencia postquirúrgica y empeora el curso general de la enfermedad.",
                            "Induce una respuesta antiinflamatoria en el colon, similar a su efecto en la colitis ulcerosa, pero tiene un efecto pro-inflamatorio en el intestino delgado."
                        ],
                        answer: 2,
                        justification: `El tabaquismo es el factor de riesgo ambiental modificable más importante. Su impacto es complejo: altera la inmunidad, promueve un microbioma pro-inflamatorio (disbiosis) y se asocia consistentemente con un curso más agresivo de la enfermedad y una mayor necesidad de cirugía. No tiene ningún efecto protector en el colon en pacientes con Crohn.`,
                        source: `(Directrices de la Sociedad Británica de Gastroenterología sobre la enfermedad inflamatoria intestinal en adultos 2025.pdf)`
                    },
                    {
                        question: `La disfunción de las células de Paneth es un mecanismo central en la fisiopatología de la Enfermedad de Crohn ileal. ¿Cuál es su consecuencia MÁS directa?`,
                        options: [
                            "Una producción deficiente de moco, lo que deja la superficie epitelial expuesta directamente a las bacterias luminales.",
                            "Una secreción reducida de péptidos antimicrobianos (ej. defensinas), lo que lleva a un control inadecuado de la microbiota y una mayor translocación bacteriana.",
                            "Una absorción alterada de nutrientes, especialmente de vitamina B12, lo que contribuye a la malnutrición y la anemia.",
                            "Una proliferación excesiva de las criptas intestinales, lo que conduce a la formación de pólipos inflamatorios y un mayor riesgo de displasia."
                        ],
                        answer: 1,
                        justification: `La función principal de las células de Paneth, situadas en la base de las criptas del intestino delgado, es secretar defensinas y otros péptidos que regulan la composición de la microbiota intestinal. Su disfunción, a menudo ligada a mutaciones en genes como NOD2 o ATG16L1, compromete esta barrera antimicrobiana. La producción de moco es tarea de las células caliciformes y la absorción de B12 ocurre en el epitelio ileal, pero no es una función directa de las células de Paneth.`,
                        source: `(Enfermedad de Crohn - The lancet 2024.pdf)`
                    }
                ]
            },
            {
                id: 2,
                title: "Módulo 2: El Espectro Clínico y el Proceso Diagnóstico",
                summary: `Este módulo aborda el diagnóstico práctico de la Enfermedad de Crohn. Se detallan las manifestaciones clínicas, desde los síntomas gastrointestinales clásicos hasta las manifestaciones extraintestinales que pueden ser la primera pista. Se establece un flujo de trabajo diagnóstico que integra biomarcadores no invasivos como la calprotectina fecal y la PCR, con las herramientas definitivas como la ileocolonoscopia con toma de biopsias y los estudios de imagen seccional (Entero-RM/TC) para evaluar la extensión transmural y las complicaciones (estenosis, fístulas).`,
                clinicalCase: `Una mujer de 30 años, sin antecedentes médicos de importancia, es derivada a gastroenterología desde reumatología. Durante el último año, ha presentado artralgias migratorias en grandes articulaciones (rodillas y tobillos) y un episodio de uveítis anterior, tratados con AINEs con alivio parcial. En el interrogatorio dirigido, refiere hinchazón abdominal postprandial y 2-3 deposiciones blandas al día, síntomas que había atribuido al "estrés y a los analgésicos". Su examen físico revela dolor a la palpación en fosa ilíaca derecha sin una masa palpable. Los laboratorios muestran una PCR de 15 mg/L (normal <5) y una hemoglobina de 11.5 g/dL.<br><br><strong>Pregunta clave:</strong> Con una presentación dominada por manifestaciones extraintestinales y síntomas digestivos sutiles, ¿cuál es el desafío diagnóstico principal y qué prueba inicial sería la más informativa para confirmar o descartar la Enfermedad de Crohn?`,
                quiz: [
                    {
                        question: `La paciente presenta una PCR elevada. ¿Cuál es la interpretación MÁS precisa del valor de la calprotectina fecal (CF) en este escenario para diferenciar entre Enfermedad de Crohn (EC) y un síndrome de intestino irritable (SII) con componente inflamatorio leve por AINEs?`,
                        options: [
                            "Un valor de CF > 500 µg/g es diagnóstico de EC, mientras que valores entre 100-250 µg/g son más sugerentes de una enteropatía por AINEs.",
                            "La CF tiene alta sensibilidad para la inflamación colónica, pero su utilidad es limitada en la sospecha de enfermedad ileal aislada, donde puede ser falsamente baja a pesar de la actividad endoscópica.",
                            "Un valor normal de CF (<50 µg/g) junto con una PCR elevada descarta de forma fiable la EC y apunta a un origen puramente reumatológico de la inflamación.",
                            "La PCR es un marcador más fiable que la CF para la actividad de la enfermedad en el intestino delgado, por lo que el resultado de la CF es secundario."
                        ],
                        answer: 1,
                        justification: `La calprotectina fecal es un excelente marcador de inflamación neutrofílica en la luz intestinal, pero su correlación es más fuerte con la enfermedad colónica. En la enfermedad de Crohn limitada al íleon terminal, los niveles pueden no ser tan elevados como se esperaría, o incluso estar en un rango equívoco. Una PCR elevada con una CF normal o levemente elevada no descarta la EC ileal. La CF >500 es altamente sugestiva pero no diagnóstica, y la enteropatía por AINEs puede elevarla significativamente.`,
                        source: `(Guía clínica del ACG, Manejo de la enfermedad de Crohn en adultos.pdf)`
                    },
                    {
                        question: `Se realiza una ileocolonoscopia. ¿Qué hallazgo histológico en las biopsias del íleon terminal apoyaría MÁS fuertemente el diagnóstico de EC sobre una tuberculosis intestinal, una de sus principales imitadoras?`,
                        options: [
                            "Presencia de granulomas epitelioides bien formados.",
                            "Inflamación crónica transmural con agregados linfoides.",
                            "Granulomas no caseificantes, pequeños y pobremente definidos, junto con una distorsión arquitectural de las criptas.",
                            "Grandes granulomas caseificantes confluentes y presencia de bacilos ácido-alcohol resistentes en la tinción de Ziehl-Neelsen."
                        ],
                        answer: 2,
                        justification: `Aunque ambos pueden presentar granulomas, los de la EC suelen ser no caseificantes, más pequeños y peor formados que los de la TB. La distorsión crónica de la arquitectura de las criptas es un sello de la cronicidad de la EII. La opción 4 es la descripción clásica de la TB intestinal y su hallazgo la confirmaría. La inflamación transmural es de Crohn, pero es un hallazgo de pieza quirúrgica, no de biopsia superficial.`,
                        source: `(Enfermedad de Crohn - The lancet 2024.pdf)`
                    },
                    {
                        question: `Para evaluar la extensión completa de la enfermedad en el intestino delgado de esta paciente de 30 años, ¿cuál es la modalidad de imagen de elección y por qué?`,
                        options: [
                            "Entero-Tomografía Computarizada (Entero-TC) por su rapidez y excelente resolución espacial para detectar fístulas y abscesos.",
                            "Cápsula endoscópica, ya que ofrece la visualización más detallada de la mucosa para detectar úlceras aftoides tempranas.",
                            "Entero-Resonancia Magnética (Entero-RM) porque ofrece una excelente evaluación de la actividad inflamatoria y el daño transmural sin exponer a la paciente a radiación ionizante.",
                            "Tránsito intestinal con bario, ya que es la mejor técnica para definir la longitud y el calibre de las estenosis funcionales."
                        ],
                        answer: 2,
                        justification: `En una paciente joven, evitar la radiación ionizante es una prioridad, lo que descarta la Entero-TC como primera opción a pesar de su utilidad. La Entero-RM se ha convertido en el estándar de oro para la evaluación inicial y el seguimiento, ya que evalúa tanto la actividad inflamatoria (edema, realce con gadolinio) como el daño crónico (fibrosis, estenosis, fístulas). La cápsula endoscópica está contraindicada si hay sospecha de estenosis y no evalúa la pared intestinal. El tránsito baritado ha sido reemplazado por técnicas seccionales.`,
                        source: `(Directrices de la Sociedad Británica de Gastroenterología sobre la enfermedad inflamatoria intestinal en adultos 2025.pdf)`
                    },
                    {
                        question: `La paciente presenta artralgias y uveítis. ¿Cuál de las siguientes afirmaciones sobre las manifestaciones extraintestinales (MEI) es MÁS correcta y relevante para su manejo?`,
                        options: [
                            "Todas las MEI, especialmente las articulares, se resuelven completamente una vez que se logra la remisión endoscópica de la enfermedad intestinal.",
                            "La artritis periférica tipo 1 (pauciarticular, grandes articulaciones) generalmente sigue un curso paralelo a la actividad de la enfermedad intestinal, mientras que la espondiloartropatía axial es independiente.",
                            "El tratamiento de la uveítis requiere siempre terapia sistémica con anti-TNF, ya que los tratamientos intestinales selectivos como vedolizumab no son efectivos.",
                            "La presencia de MEI como la artritis clasifica automáticamente la enfermedad como severa, requiriendo inicio inmediato de terapia biológica combinada."
                        ],
                        answer: 1,
                        justification: `Es crucial distinguir entre las MEI que se correlacionan con la actividad intestinal y las que no. La artritis periférica tipo 1 (que afecta a esta paciente) tiende a mejorar con el control de la inflamación intestinal. En cambio, la espondilitis anquilosante o la sacroileítis (axiales) tienen un curso independiente. Vedolizumab, al ser selectivo del intestino, no es la mejor opción para MEI sistémicas activas. La presencia de MEI es un factor de mal pronóstico, pero no obliga per se a una terapia combinada de inicio; la elección del tratamiento debe considerar qué dominios (intestinal y extraintestinal) se necesitan tratar.`,
                        source: `(Directrices de la ECCO sobre la terapéutica en la enfermedad de Crohn. Tratamiento médico 2024.pdf)`
                    },
                    {
                        question: `Si en la biopsia del íleon se reporta "infiltrado inflamatorio agudo con neutrófilos en la lámina propia y criptitis focal" pero SIN distorsión de la arquitectura de las criptas ni granulomas, ¿cuál sería la interpretación MÁS prudente?`,
                        options: [
                            "Los hallazgos son suficientes para diagnosticar Enfermedad de Crohn de inicio reciente.",
                            "Los hallazgos son inespecíficos y podrían corresponder a una ileítis infecciosa, por AINEs o una etapa muy temprana de EC, requiriendo correlación clínica y seguimiento.",
                            "La ausencia de granulomas y de distorsión arquitectural descarta de forma fiable la Enfermedad de Crohn.",
                            "Estos hallazgos sugieren fuertemente Colitis Ulcerosa con \"backwash ileitis\", a pesar de la presentación clínica."
                        ],
                        answer: 1,
                        justification: `La inflamación aguda sin cambios crónicos (distorsión de criptas, atrofia vellositaria, metaplasia de células de Paneth) es un hallazgo inespecífico. Si bien podría ser el inicio de una EC, muchas otras condiciones pueden causarlo, incluyendo infecciones (Yersinia, Salmonella) y la enteropatía por AINEs, muy relevante en este caso. No se puede diagnosticar ni descartar EC con certeza solo con estos hallazgos; la cronicidad es la clave histológica.`,
                        source: `(Directrices de la Sociedad Británica de Gastroenterología sobre la enfermedad inflamatoria intestinal en adultos 2025.pdf)`
                    }
                ]
            }
        ];

        let userProgress = {};
        let currentModuleId = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadProgress();
            renderModuleList();
            
            let lastModuleId = null;
            try {
                lastModuleId = localStorage.getItem('crohnLastModuleId');
            } catch (e) {
                console.error("Error al obtener el último módulo:", e);
            }
            displayModule(lastModuleId ? parseInt(lastModuleId) : null);

            setupEventListeners();
        });

        function setupEventListeners() {
            const resetButton = document.getElementById('reset-button');
            const resetModal = document.getElementById('reset-modal');
            const cancelReset = document.getElementById('cancel-reset');
            const confirmReset = document.getElementById('confirm-reset');
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const closeGeminiModal = document.getElementById('close-gemini-modal');
            const geminiModal = document.getElementById('gemini-modal');
            
            resetButton.addEventListener('click', () => {
                resetModal.classList.remove('hidden');
                setTimeout(() => {
                    resetModal.querySelector('div').classList.remove('scale-95');
                }, 10);
            });
            cancelReset.addEventListener('click', () => {
                resetModal.querySelector('div').classList.add('scale-95');
                setTimeout(() => resetModal.classList.add('hidden'), 300);
            });
            confirmReset.addEventListener('click', resetProgress);
            
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
                sidebarOverlay.classList.toggle('hidden');
            });
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            });

            closeGeminiModal.addEventListener('click', hideGeminiModal);
            geminiModal.addEventListener('click', (event) => {
                if (event.target === geminiModal) {
                    hideGeminiModal();
                }
            });
        }
        
        function initializeProgress() {
            userProgress = {};
            courseModules.forEach(module => {
                userProgress[module.id] = { completed: false, score: 0, answers: {} };
            });
        }
        
        function loadProgress() {
            try {
                const savedProgress = localStorage.getItem('crohnCourseProgress');
                if (savedProgress && Object.keys(JSON.parse(savedProgress)).length === courseModules.length) {
                    userProgress = JSON.parse(savedProgress);
                } else {
                    initializeProgress();
                }
            } catch (e) {
                console.error("Error al cargar el progreso:", e);
                initializeProgress();
            }
            updateProgressBar();
        }

        function saveProgress() {
            try {
                localStorage.setItem('crohnCourseProgress', JSON.stringify(userProgress));
                if (currentModuleId) {
                    localStorage.setItem('crohnLastModuleId', currentModuleId);
                }
            } catch (e) {
                console.error("Error al guardar el progreso:", e);
            }
        }
        
        function resetProgress() {
            try {
                localStorage.removeItem('crohnCourseProgress');
                localStorage.removeItem('crohnLastModuleId');
            } catch (e) {
                console.error("Error al reiniciar el progreso:", e);
            }
            window.location.reload();
        }

        function renderModuleList() {
            const list = document.getElementById('module-list');
            list.innerHTML = '';
            courseModules.forEach(module => {
                const li = document.createElement('li');
                const isCompleted = userProgress[module.id] && userProgress[module.id].completed;
                const isActive = module.id === currentModuleId;

                const baseClasses = 'p-3 rounded-lg cursor-pointer transition-all duration-200 flex items-center gap-3';
                let stateClasses = 'bg-slate-700 hover:bg-slate-600 hover:pl-4';
                let iconHtml = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-70 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 0114.5 16c1.255 0 2.443-.29 3.5-.804v-10A7.968 7.968 0 0014.5 4z" /></svg>`;
                
                if (isCompleted) {
                    stateClasses = 'bg-emerald-800/80 hover:bg-emerald-700/80 text-emerald-300';
                    iconHtml = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-400 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;
                }
                if (isActive) {
                    stateClasses = 'bg-sky-600 font-bold text-white shadow-lg';
                }
                
                li.className = `${baseClasses} ${stateClasses}`;
                li.innerHTML = `${iconHtml} <span>${module.title}</span>`;
                li.dataset.moduleId = module.id;
                li.onclick = () => {
                    displayModule(module.id);
                    if (window.innerWidth < 1024) {
                        document.getElementById('sidebar').classList.add('-translate-x-full');
                        document.getElementById('sidebar-overlay').classList.add('hidden');
                    }
                };
                list.appendChild(li);
            });
        }
        
        function displayWelcomeScreen() {
             const displayArea = document.getElementById('module-display');
             const completedCount = Object.values(userProgress).filter(p => p.completed).length;
             const totalCount = courseModules.length;
             const firstUncompleted = courseModules.find(m => !userProgress[m.id].completed);
             const buttonText = completedCount > 0 ? "Continuar Curso" : "Comenzar Curso";
             const targetModuleId = firstUncompleted ? firstUncompleted.id : courseModules[0].id;
            
             displayArea.innerHTML = `
                <div class="bg-white p-8 sm:p-12 rounded-2xl shadow-xl text-center">
                    <h2 class="text-3xl sm:text-4xl font-bold text-slate-800">Bienvenido al Curso sobre Enfermedad de Crohn</h2>
                    <p class="text-slate-600 mt-3 max-w-2xl mx-auto">Este curso interactivo está diseñado para evaluar y reforzar tus conocimientos sobre la Enfermedad de Crohn, desde la fisiopatología hasta el manejo clínico avanzado.</p>
                    <div class="mt-8">
                        <p class="text-lg font-semibold text-slate-700">Tu Progreso:</p>
                        <p class="text-4xl font-bold text-sky-600 mt-2">${completedCount} / ${totalCount} Módulos Completados</p>
                    </div>
                    <button class="mt-10 bg-sky-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition-all hover:bg-sky-700 active:scale-95 text-lg" onclick="displayModule(${targetModuleId})">
                        ${buttonText}
                    </button>
                </div>
             `;
        }

        function displayModule(moduleId) {
            if (!document.getElementById('main-content')) return;
            document.getElementById('main-content').scrollTop = 0;
            
            const displayArea = document.getElementById('module-display');
            if (!displayArea) return;
            displayArea.classList.add('opacity-0');

            setTimeout(() => {
                currentModuleId = moduleId ? parseInt(moduleId) : null;
                
                if (!currentModuleId) {
                    displayWelcomeScreen();
                    renderModuleList();
                    displayArea.classList.remove('opacity-0');
                    return;
                }
            
                const moduleData = courseModules.find(m => m.id === currentModuleId);
                
                if (!moduleData) {
                    console.error("Módulo no encontrado:", currentModuleId);
                    displayWelcomeScreen();
                    displayArea.classList.remove('opacity-0');
                    return;
                }

                localStorage.setItem('crohnLastModuleId', currentModuleId);
                
                if (userProgress[currentModuleId] && userProgress[currentModuleId].completed) {
                    showCompletedModule(currentModuleId);
                } else {
                    showActiveModule(currentModuleId);
                }

                renderModuleList();
                displayArea.classList.remove('opacity-0');
            }, 200);
        }

        function showActiveModule(moduleId) {
            const moduleData = courseModules.find(m => m.id === moduleId);
            const displayArea = document.getElementById('module-display');

            let quizHtml = `<form class="quiz-form space-y-6 mt-8" id="quiz-form-${moduleId}">`;
            moduleData.quiz.forEach((q, index) => {
                quizHtml += `<div class="question-block bg-white p-6 rounded-xl shadow-lg border border-slate-100" id="q-block-${moduleId}-${index}">
                                    <p class="font-semibold text-slate-800 mb-4 text-base sm:text-lg">${index + 1}. ${q.question}</p>
                                    <div class="space-y-3">`;
                q.options.forEach((opt, optIndex) => {
                    quizHtml += `<label class="flex items-center p-4 border-2 border-slate-200 rounded-lg cursor-pointer transition-all duration-200 hover:bg-sky-50 hover:border-sky-400 has-[:checked]:bg-sky-100 has-[:checked]:border-sky-500 has-[:checked]:ring-2 has-[:checked]:ring-sky-200">
                                        <input type="radio" name="q${index}" value="${optIndex}" class="h-5 w-5 text-sky-600 border-slate-300 focus:ring-sky-500 focus:ring-2">
                                        <span class="ml-4 text-slate-700">${opt}</span>
                                     </label>`;
                });
                quizHtml += `</div></div>`;
            });
            quizHtml += `<button type="button" class="submit-quiz-btn w-full sm:w-auto bg-sky-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition-all hover:bg-sky-700 active:scale-95 disabled:bg-slate-400 disabled:cursor-not-allowed" onclick="submitQuiz(${moduleId})">Validar Respuestas</button></form>`;

            displayArea.innerHTML = `
                <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
                    <h2 class="text-2xl sm:text-3xl font-bold text-slate-900">${moduleData.title}</h2>
                    <div class="mt-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-3">Caso Clínico</h3>
                        <div class="case-study bg-amber-50 border-l-4 border-amber-500 p-5 rounded-r-lg text-amber-900 space-y-2">${moduleData.clinicalCase}</div>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-xl font-bold text-slate-800">Test de Autoevaluación</h3>
                        ${quizHtml}
                    </div>
                </div>
            `;
        }

        function showCompletedModule(moduleId) {
            const moduleData = courseModules.find(m => m.id === parseInt(moduleId));
            const progressData = userProgress[moduleId];
            const displayArea = document.getElementById('module-display');
            const nextModule = courseModules.find(m => m.id === moduleId + 1);

            let quizHtml = '<div class="quiz-form space-y-8 mt-6">';
            moduleData.quiz.forEach((q, index) => {
                const userAnswer = progressData.answers ? progressData.answers[index] : null;
                const isCorrect = userAnswer === q.answer;

                let feedbackHtml = `<div class="question-block bg-white p-6 rounded-xl shadow-lg border border-slate-100">
                                    <p class="font-semibold text-slate-800 mb-4 text-base sm:text-lg">${index + 1}. ${q.question}</p>
                                    <div class="space-y-3">`;
                
                q.options.forEach((opt, optIndex) => {
                    const isUserAnswer = optIndex === userAnswer;
                    const isCorrectAnswer = optIndex === q.answer;
                    
                    let labelClasses = 'flex items-center justify-between p-4 border-2 rounded-lg';
                    let icon = '';

                    if (isCorrectAnswer) {
                        labelClasses += ' bg-emerald-50 border-emerald-500';
                        if (isUserAnswer) icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-emerald-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;
                    } else if (isUserAnswer) {
                        labelClasses += ' bg-red-50 border-red-500';
                        icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`;
                    } else {
                         labelClasses += ' border-slate-200 bg-slate-50 opacity-80';
                    }

                    feedbackHtml += `<div class="${labelClasses}">
                                        <span class="text-slate-700">${opt}</span>
                                        ${icon}
                                     </div>`;
                });
                
                let geminiButton = '';
                if (!isCorrect) {
                    const escapedQuestion = q.question.replace(/"/g, '&quot;').replace(/'/g, "\\'");
                    const escapedJustification = q.justification.replace(/"/g, '&quot;').replace(/'/g, "\\'");
                    geminiButton = `<button class="mt-3 text-sm font-semibold text-sky-600 hover:text-sky-700 transition-colors flex items-center gap-1.5" onclick="getSimplifiedExplanation('${escapedQuestion}', '${escapedJustification}')">
                        <span class="text-transparent bg-clip-text bg-gradient-to-r from-sky-500 to-emerald-500">✨</span>
                        Explicación Sencilla
                    </button>`;
                }

                const justificationClasses = `mt-4 p-4 rounded-lg border-l-4 ${isCorrect ? 'bg-emerald-50 border-emerald-500 text-emerald-900' : 'bg-red-50 border-red-500 text-red-900'}`;
                const justificationHtml = `<div class="${justificationClasses}">
                                                <p><strong class="font-bold">${isCorrect ? 'Correcto' : 'Incorrecto'}.</strong> ${q.justification}</p>
                                                <p class="text-sm italic mt-2 opacity-80">Fuente: ${q.source}</p>
                                                ${geminiButton}
                                           </div>`;

                feedbackHtml += `</div>${justificationHtml}</div>`;
                quizHtml += feedbackHtml;
            });
            
            let nextModuleButton = '';
            if (nextModule) {
                nextModuleButton = `<button class="mt-10 w-full sm:w-auto bg-sky-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition-all hover:bg-sky-700 active:scale-95 text-lg" onclick="displayModule(${nextModule.id})">
                    Continuar al Módulo ${nextModule.id}
                </button>`;
            } else {
                 nextModuleButton = `<p class="mt-10 font-semibold text-emerald-600">¡Felicidades, has completado todos los módulos!</p>`;
            }

            displayArea.innerHTML = `
                <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
                    <h2 class="text-2xl sm:text-3xl font-bold text-slate-900">${moduleData.title} (Revisión)</h2>
                     <div class="module-summary mt-6 bg-sky-50 border-l-4 border-sky-500 p-5 rounded-r-lg text-sky-900">
                         <h3 class="font-bold text-lg mb-2">Resumen del Módulo</h3>
                         <p>${moduleData.summary}</p>
                     </div>
                    <div class="mt-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-3">Caso Clínico</h3>
                        <div class="case-study bg-amber-50 border-l-4 border-amber-500 p-5 rounded-r-lg text-amber-900 space-y-2">${moduleData.clinicalCase}</div>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mt-8">Resultados del Test</h3>
                    ${quizHtml}
                    <div class="text-center">
                        ${nextModuleButton}
                    </div>
                </div>`;
        }


        function submitQuiz(moduleId) {
            const moduleData = courseModules.find(m => m.id === moduleId);
            const form = document.getElementById('quiz-form-' + moduleId);
            let score = 0;
            let userAnswers = {};

            moduleData.quiz.forEach((q, index) => {
                const selectedOption = form.querySelector(`input[name="q${index}"]:checked`);
                if (selectedOption) {
                    const answerIndex = parseInt(selectedOption.value);
                    userAnswers[index] = answerIndex;
                    if (answerIndex === q.answer) {
                        score++;
                    }
                } else {
                    userAnswers[index] = null;
                }
            });
            
            userProgress[moduleId].completed = true;
            userProgress[moduleId].score = score;
            userProgress[moduleId].answers = userAnswers;
            
            saveProgress();
            updateProgressBar();
            renderModuleList();
            
            showCompletedModule(moduleId);
            
            checkCourseCompletion();
        }

        function updateProgressBar() {
            const completedModules = Object.values(userProgress).filter(p => p && p.completed).length;
            const totalModules = courseModules.length;
            const percentage = totalModules > 0 ? (completedModules / totalModules) * 100 : 0;
            
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = Math.round(percentage) + '%';
        }

        function checkCourseCompletion() {
            const completedModules = Object.values(userProgress).filter(p => p && p.completed).length;
            if (completedModules === courseModules.length) {
                setTimeout(calculateFinalScore, 2000);
            }
        }

        function calculateFinalScore() {
            let totalScore = 0;
            let totalQuestions = 0;
            
            courseModules.forEach(module => {
                if(userProgress[module.id] && userProgress[module.id].completed) {
                    totalScore += userProgress[module.id].score;
                    totalQuestions += module.quiz.length;
                }
            });
            
            const finalPercentage = totalQuestions > 0 ? (totalScore / totalQuestions) * 100 : 0;
            
            const displayArea = document.getElementById('module-display');
            displayArea.innerHTML = `
                <div id="final-score-screen" class="text-center bg-white p-8 sm:p-12 rounded-2xl shadow-xl transform transition-all duration-500 scale-100 opacity-100">
                    <h2 class="text-3xl sm:text-4xl font-bold text-sky-600">¡Curso Completado!</h2>
                    <p class="text-slate-600 mt-2">Has finalizado todos los módulos de preparación sobre Enfermedad de Crohn.</p>
                    <p class="mt-6 text-slate-700">Tu calificación final es:</p>
                    <p id="score-value" class="text-5xl sm:text-7xl font-bold text-slate-800 mt-2">${Math.round(finalPercentage)}<span class="text-3xl text-slate-500"> / 100</span></p>
                </div>`;
        }

        // --- Gemini API Functions ---
        function showGeminiModal() {
            const modal = document.getElementById('gemini-modal');
            const content = document.getElementById('gemini-response');
            const loader = document.getElementById('gemini-loader');

            content.innerHTML = '';
            content.classList.add('hidden');
            loader.classList.remove('hidden');
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('div').classList.remove('scale-95');
            }, 10);
        }

        function hideGeminiModal() {
            const modal = document.getElementById('gemini-modal');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        async function getSimplifiedExplanation(question, justification) {
            showGeminiModal();

            const apiKey = ""; // Canvas will provide this
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = "Eres un tutor médico experto en Enfermedad de Crohn. Tu tarea es explicar conceptos complejos de gastroenterología de una manera muy sencilla, clara y concisa, como si se lo explicaras a un estudiante de medicina de primer año. Usa analogías si es posible. Responde siempre en español.";
            const userQuery = `La pregunta fue: "${question}". La justificación del libro es: "${justification}". Por favor, dame una explicación más sencilla de este concepto clave.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let responseText = "Hubo un problema al contactar al asistente de IA. Por favor, intenta de nuevo más tarde.";
            try {
                let response;
                let retries = 3;
                let delay = 1000;

                for (let i = 0; i < retries; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) break;
                    if (response.status === 429 || response.status >= 500) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        break;
                    }
                }
                
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    responseText = candidate.content.parts[0].text
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/\n/g, '<br>');
                }

            } catch (error) {
                console.error("Error calling Gemini API:", error);
            } finally {
                const content = document.getElementById('gemini-response');
                const loader = document.getElementById('gemini-loader');
                content.innerHTML = responseText;
                content.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }
    </script>
</body>
</html>



